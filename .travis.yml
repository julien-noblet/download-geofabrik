language: go
sudo: false

go:
  - "1.11"
  - "1.10"
  - "1.9"
  - "1.8"
  - "1.7"
  - stable
  - master
  - tip

before_install:
  - go get github.com/mattn/goveralls

install:
  - go get -v github.com/mitchellh/gox
  - go get -t -v ./...

script: go test -bench=. -benchmem -v ./...

stages:
  - test
  - goveralls
  - Geofabrik
  - OSMfr
  - GisLab
  - Readme
  - "build stable"
  - "build 1.7"
  - "build 1.8"
  - "build 1.9"
  - "build 1.10"
  - "build 1.11"
  - "build tip"
  - deploy

jobs:
  include:
    - stage: Geofabrik
      if: tag IS present OR commit_message =~ /(yaml|YAML|\.yml|geofabrik|Geofabrik)/ OR commit_message !~ /(ci|chore|docs|refactor|perf|style)/
      go: stable
      script: make geofabrik
    - stage: OSMfr
      if: tag IS present OR commit_message =~ /(yaml|YAML|\.yml|osmfr|OSMfr|openstreetmap\.fr)/ OR commit_message !~ /(ci|chore|docs|refactor|perf|style)/
      go: stable
      script: make osmfr
    - stage: GisLab
      if: tag IS present OR commit_message =~ /(yaml|YAML|\.yml|gislab|GisLab)/ OR commit_message !~ /(ci|chore|docs|refactor|perf|style)/
      go: stable
      script: make gislab
    - stage: Readme
      if: tag IS present OR commit_message =~ /(Readme|readme)/
      go: stable
      script: make readme
    - stage: goveralls
      if: tag IS present OR commit_message !~ /(no-coverage|no-test)/
      go: stable
      script: $GOPATH/bin/goveralls -service=travis-ci
    - stage: "build 1.10"
      if: tag IS present OR ( commit_message =~ /(force-build|ci|chore|refactor|style|perf)/ AND commit_message !~ /(no-build|no-1_10)/ )
      go: stable
      script: make
    - stage: "build 1.9"
      if: tag IS present OR ( commit_message =~ /(force-build|ci|chore|refactor|style|perf)/ AND commit_message !~ /(no-build|no-1_9)/ )
      go: "1.9"
      script: make
    - stage: "build 1.8"
      if: tag IS present OR ( commit_message =~ /(force-build|ci|chore|refactor|style|perf)/ AND commit_message !~ /(no-build|no-1_8)/ )
      go: "1.8"
      script: make
    - stage: "build 1.7"
      if: tag IS present OR ( commit_message =~ /(force-build|ci|chore|refactor|style|perf)/ AND commit_message !~ /(no-build|no-1_7)/ )
      go: "1.7"
      script: make
    - stage: "build 1.11"
      if: tag IS present OR commit_message !~ /(no-build)/
      go: "1.11"
      script: make
    - stage: "build tip"
      if: tag IS present OR commit_message !~ /(no-build)/
      go: tip
      script: make
    - stage: "build stable"
      if: tag IS present OR commit_message !~ /(no-build)/
      go: stable
      script: make
    - stage: deploy
      if: commit_message =~ /(test-deploy|ci)/ OR (tag IS present AND tag !~ /(no-deploy)/ AND commit_message !~ /(no-deploy)/)
      script: make
      go: stable
      deploy:
        provider: releases
        api_key:
          secure: "o+lsHtm1FV0Hu/FHOyujZE11pTJuexUwWQtbiYr21Z4+BEcDzVN+Pxr2s1JnmNKcl7wqNBVSyNAnXUpqUWcgwi9liM9dOn+DcHUAT4eMM/zTm9vgf1qjxfoDJK3suXLQlzRNGkygz6PFGZvICjSmJTDsGTNpEIezFdXupOvZgnc5CT7qp+xBB95tQlWfaRVeCkSKqRyOK09J+scliwJR6SZlGqBUSDkb9RPMxpZ2wjNYf8fWQFHtzBcutT9gFJZLE2WPei6or6jOm7i6Haaa7Pg4Lhrlge7N1fq6FsQbcHqLX3F349voN5Nt+TtxY3sIeACNHqNkEuxkQnjAkTKoF+DTODXnwOjp6Mp1xb4LK+ejfYUppF6384sFDmKIc7xNJU1Mmwp+Bqw1q3WNyYqAbwLTC/UIlADIVglOH9r8bLJGikRPJPR3QnEznIL06l5lM34wNicvhqSKSIf06kxAXwAK7QD6prBPuTmlCZFNDASDw7E/IjUd3tXTgYvj8Fb8pMa4jsb7Bafgbo2sliicFuC+ua7CWvTWjlsMSJPLkdbEJku1VSdTTTV/rK8sqRbgc/Q/8BOQm/6ZCGntWtHacsefopaMuJR7hhMUaviNZOsjUunn+fkTNWByLX2nHHJAuyNbAXgpxwIkGGZONvfNxgi8Dw2Oz5sM6EUcKxSxTBM="
        file:
          - "download-geofabrik_darwin_386.zip"
          - "download-geofabrik_darwin_amd64.zip"
          - "download-geofabrik_freebsd_386.zip"
          - "download-geofabrik_freebsd_amd64.zip"
          - "download-geofabrik_freebsd_arm.zip"
          - "download-geofabrik_linux_386.zip"
          - "download-geofabrik_linux_amd64.zip"
          - "download-geofabrik_linux_arm.zip"
          - "download-geofabrik_linux_mips.zip"
          - "download-geofabrik_linux_mips64.zip"
          - "download-geofabrik_linux_mips64le.zip"
          - "download-geofabrik_linux_mipsle.zip"
          - "download-geofabrik_linux_s390x.zip"
          - "download-geofabrik_netbsd_386.zip"
          - "download-geofabrik_netbsd_amd64.zip"
          - "download-geofabrik_netbsd_arm.zip"
          - "download-geofabrik_openbsd_386.zip"
          - "download-geofabrik_openbsd_amd64.zip"
          - "download-geofabrik_windows_386.zip"
          - "download-geofabrik_windows_amd64.zip"
        skip_cleanup: true
        on:
          tags: true
